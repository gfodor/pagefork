// Generated by CoffeeScript 1.5.0
(function() {

  $(function() {
    var initDoc, phorkId, readyDocs, totalDocs;
    phorkId = $('body').data('phorkId');
    readyDocs = 0;
    totalDocs = 0;
    initDoc = function(docInfo, sjs) {
      var doc;
      totalDocs += 1;
      doc = sjs.get('docs', docInfo.doc_id);
      doc.subscribe();
      return doc.whenReady(function() {
        var aceEditor, codeDiv, component, editor, resetTest, showWhenReady, target, testComponent, testCount;
        codeDiv = $("<div>").prop("id", "code-" + docInfo.doc_id);
        editor = $("<div>");
        codeDiv.append(editor);
        $("#phork-ui .tabs").append(codeDiv);
        aceEditor = ace.edit("code-" + docInfo.doc_id);
        $("#code-" + docInfo.doc_id).addClass("code-editor");
        aceEditor.getSession().setMode("ace/mode/" + docInfo.type);
        aceEditor.setTheme("ace/theme/monokai");
        doc.attach_ace(aceEditor);
        if (docInfo.primary) {
          component = new HtmlRenderer({
            content: doc.snapshot
          });
          target = $("#doc-container .phork-html")[0];
          testComponent = null;
          testCount = 0;
          resetTest = function() {
            var testTargetSel;
            if (testComponent) {
              testComponent.unmountComponent();
            }
            (function(id) {
              return setTimeout((function() {
                return $(id).remove();
              }), 0);
            })("#phork-test-" + testCount);
            testTargetSel = $("<div>").addClass("phork-html-test").attr("id", "phork-test-" + (++testCount));
            $("#doc-container").append(testTargetSel);
            testComponent = new HtmlRenderer({
              content: "<div>hello</div>"
            });
            return React.renderComponent(testComponent, testTargetSel[0]);
          };
          aceEditor.getSession().on("change", function(e) {
            var f;
            f = function() {
              var html;
              try {
                html = aceEditor.getValue();
                console.log("ok");
                return component.setProps({
                  content: html
                });
              } catch (e) {
                console.log(" stop");
                console.log(e.stack);
                return component.forceUpdate();
              }
            };
            setTimeout(f, 0);
            return true;
          });
          readyDocs += 1;
          showWhenReady = function() {
            if (readyDocs >= totalDocs) {
              React.renderComponent(component, target);
              return resetTest();
            } else {
              return setTimeout(showWhenReady, 500);
            }
          };
          return showWhenReady();
        } else if (docInfo.type === "css") {
          component = new CssRenderer();
          setTimeout((function() {
            component.update(docInfo.doc_id, doc.snapshot);
            return readyDocs += 1;
          }), 0);
          return aceEditor.getSession().on("change", function(e) {
            setTimeout((function() {
              return component.update(docInfo.doc_id, doc.snapshot);
            }), 0);
            return true;
          });
        }
      });
    };
    return $.get("/phorks/" + phorkId + ".json", {
      dataType: "json"
    }, function(res) {
      var docInfo, sjs, socket, _i, _len, _ref, _results;
      socket = new BCSocket(null, {
        reconnect: true
      });
      sjs = new window.sharejs.Connection(socket);
      _ref = res.docs;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        docInfo = _ref[_i];
        _results.push(initDoc(docInfo, sjs));
      }
      return _results;
    });
  });

}).call(this);
